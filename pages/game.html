<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game - C·ªù T∆∞·ªõng Online</title>
    <link rel="stylesheet" href="../public/css/board.css">
    <!-- Game page needs board.css only, has inline styles for game UI -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            overflow: hidden;
        }

        .game-page {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .game-header {
            background: #16213e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .game-title {
            color: white;
            margin: 0;
            font-size: 1.3em;
        }

        .game-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .game-container {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }

        .game-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .player-panel {
            width: 100%;
            max-width: 600px;
            background: #16213e;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .player-panel.active {
            border: 3px solid #ffd700;
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700;
            }
            50% {
                box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
            }
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .player-details {
            flex: 1;
        }

        .player-name {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .player-rating {
            color: #aaa;
            font-size: 0.9em;
        }

        .timer-display {
            background: #0f1419;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
            font-family: 'Courier New', monospace;
        }

        .timer-display.warning {
            color: #ff4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .board-container {
            background: #16213e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .game-right {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .turn-indicator {
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .turn-text {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
        }

        .game-panel {
            background: #16213e;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            color: white;
            margin: 0 0 15px 0;
            font-size: 1.1em;
            border-bottom: 2px solid #0f3460;
            padding-bottom: 10px;
        }

        .moves-list {
            flex: 1;
            overflow-y: auto;
            color: white;
            font-size: 0.9em;
            max-height: 200px;
        }

        .move-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #0f3460;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }

        .move-number {
            color: #ffd700;
            font-weight: bold;
        }

        .game-chat {
            display: flex;
            flex-direction: column;
            background: #16213e;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #333;
            height: 320px;
        }

        .chat-header {
            padding: 10px;
            background: #16213e;
            color: #ccc;
            font-size: 0.9em;
            border-bottom: 1px solid #444;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #161623;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        .chat-message.me {
            align-self: flex-end;
            align-items: flex-end;
        }

        .chat-message.opponent {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-sender {
            font-size: 0.75em;
            color: #888;
            margin-bottom: 4px;
            margin-left: 5px;
            margin-right: 5px;
        }

        .message-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.95em;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .me .message-bubble {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .opponent .message-bubble {
            background: #3a3a4c;
            color: #e0e0e0;
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            margin-top: auto;
            padding: 15px; 
            background: #16213e;
            border-top: 1px solid #444; 
            
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #chat-input {
            flex: 1; /* Chi·∫øm to√†n b·ªô kho·∫£ng tr·ªëng c√≤n l·∫°i */
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid #555;
            background: #161623;
            color: white;
            outline: none;
            font-size: 14px;
        }

        #btn-send-chat {
            /* Fix k√≠ch th∆∞·ªõc n√∫t g·ª≠i */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            
            /* CƒÉn icon/text v√†o gi·ªØa n√∫t */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0; /* Kh√¥ng b·ªã co l·∫°i khi m√†n h√¨nh nh·ªè */
            transition: background 0.2s;
        }

        #btn-send-chat:hover {
            background: #0056b3;
        }

        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .game-controls .btn {
            width: 100%;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #16213e;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            margin-top: 0;
            font-size: 2em;
        }

        .result-stats {
            margin: 20px 0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: #0f3460;
            border-radius: 5px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="game-page">
        <header class="game-header">
            <h1 class="game-title">ƒêang Ch∆°i</h1>
            <div class="game-actions">
                <button class="btn btn-warning" id="btn-draw-offer">Xin H√≤a</button>
                <button class="btn btn-danger" id="btn-resign">ƒê·∫ßu H√†ng</button>
                <button class="btn btn-secondary" id="btn-leave">R·ªùi</button>
            </div>
        </header>

        <div class="game-container">
            <div class="game-left">
                <!-- Opponent Panel -->
                <div class="player-panel" id="opponent-panel">
                    <div class="player-avatar">‚ö´</div>
                    <div class="player-details">
                        <div class="player-name" id="opponent-name">ƒê·ªëi th·ªß</div>
                        <div class="player-rating" id="opponent-rating">‚≠ê 1500</div>
                    </div>
                    <div class="timer-display" id="opponent-timer">10:00</div>
                </div>

                <!-- Board -->
                <div class="board-container">
                    <div id="xiangqi-board"></div>
                </div>

                <!-- Current Player Panel -->
                <div class="player-panel active" id="player-panel">
                    <div class="player-avatar">üî¥</div>
                    <div class="player-details">
                        <div class="player-name" id="player-name">B·∫°n</div>
                        <div class="player-rating" id="player-rating">‚≠ê 1500</div>
                    </div>
                    <div class="timer-display" id="player-timer">10:00</div>
                </div>
            </div>

            <div class="game-right">
                <!-- Turn Indicator -->
                <div class="turn-indicator">
                    <div class="turn-text" id="turn-text">‚è≥ L∆∞·ª£t ƒë·ªëi th·ªß</div>
                </div>

                <!-- Move History -->
                <div class="game-panel">
                    <h3 class="panel-header">üìú L·ªãch S·ª≠ N∆∞·ªõc ƒêi</h3>
                    <div class="moves-list" id="moves-list">
                        <div style="color: #aaa; text-align: center; padding: 20px;">
                            Ch∆∞a c√≥ n∆∞·ªõc ƒëi n√†o
                        </div>
                    </div>
                </div>

                <!-- Chat -->
                <div class="game-chat">
                    <div class="chat-header">Tr√≤ chuy·ªán</div>
                    
                    <div class="chat-messages" id="chat-messages">
                    </div>
                    
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
                        
                        <button id="btn-send-chat">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal" id="result-modal">
        <div class="modal-content">
            <h2 id="result-title">K·∫øt Qu·∫£</h2>
            <div class="result-stats">
                <div class="stat-row">
                    <span>K·∫øt qu·∫£:</span>
                    <strong id="result-outcome">-</strong>
                </div>
                <div class="stat-row">
                    <span>S·ªë n∆∞·ªõc ƒëi:</span>
                    <strong id="result-moves">0</strong>
                </div>
                <div class="stat-row">
                    <span>Th·ªùi gian:</span>
                    <strong id="result-time">00:00</strong>
                </div>
                <div class="stat-row">
                    <span>Rating thay ƒë·ªïi:</span>
                    <strong id="result-rating-change">+0</strong>
                </div>
                <div class="stat-row">
                    <span>Rating m·ªõi:</span>
                    <strong id="result-new-rating">1500</strong>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-warning" id="btn-rematch">üîÑ ƒê·∫•u L·∫°i</button>
                <button class="btn btn-primary" id="btn-new-game">Tr·∫≠n M·ªõi</button>
                <button class="btn btn-secondary" id="btn-to-lobby">Lobby</button>
            </div>
        </div>
    </div>

    <!-- Draw Offer Modal -->
    <div class="modal" id="draw-modal">
        <div class="modal-content">
            <h2>ƒê·ªÅ Ngh·ªã H√≤a</h2>
            <p>ƒê·ªëi th·ªß ƒë·ªÅ ngh·ªã h√≤a. B·∫°n ƒë·ªìng √Ω kh√¥ng?</p>
            <div class="modal-actions">
                <button class="btn btn-primary" id="btn-accept-draw">ƒê·ªìng √ù</button>
                <button class="btn btn-danger" id="btn-decline-draw">T·ª´ Ch·ªëi</button>
            </div>
        </div>
    </div>

    <!-- Rematch Request Modal -->
    <div class="modal" id="rematch-modal">
        <div class="modal-content">
            <h2>üîÑ Y√™u C·∫ßu ƒê·∫•u L·∫°i</h2>
            <p id="rematch-request-text">ƒê·ªëi th·ªß mu·ªën ƒë·∫•u l·∫°i. B·∫°n ƒë·ªìng √Ω kh√¥ng?</p>
            <div class="modal-actions">
                <button class="btn btn-primary" id="btn-accept-rematch">ƒê·ªìng √ù</button>
                <button class="btn btn-danger" id="btn-decline-rematch">T·ª´ Ch·ªëi</button>
            </div>
        </div>
    </div>

    <!-- Waiting for Rematch Response Modal -->
    <div class="modal" id="rematch-waiting-modal">
        <div class="modal-content">
            <h2>‚è≥ ƒêang Ch·ªù</h2>
            <p>ƒêang ch·ªù ƒë·ªëi th·ªß ph·∫£n h·ªìi y√™u c·∫ßu ƒë·∫•u l·∫°i...</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="btn-cancel-rematch">H·ªßy</button>
            </div>
        </div>
    </div>

    <script type="module">
        import NetworkGameController from '../src/core/networkGameController.js?v=7';

        // 1. Kh·ªüi t·∫°o d·ªØ li·ªáu
        const userDataStr = localStorage.getItem('xiangqi_user');
        const matchDataStr = localStorage.getItem('current_match');
        const spectateDataStr = localStorage.getItem('spectate_match');

        // Check for spectate mode
        const urlParams = new URLSearchParams(window.location.search);
        const isSpectateMode = urlParams.get('mode') === 'spectate';

        if (!userDataStr) {
            window.location.href = 'login.html';
        }

        const userData = JSON.parse(userDataStr);
        let matchData = matchDataStr ? JSON.parse(matchDataStr) : null;
        let spectateData = spectateDataStr ? JSON.parse(spectateDataStr) : null;

        // 2. Kh·ªüi t·∫°o Controller
        const gameController = new NetworkGameController('xiangqi-board');
        window.gameController = gameController;

        // --- Spectate Mode Setup ---
        if (isSpectateMode && spectateData) {
            gameController.matchId = spectateData.match_id;
            gameController.isOnlineMode = true;
            gameController.isSpectator = true;
            gameController.isMyTurn = false; // Spectators can't move
            
            // Hide game action buttons for spectators
            const gameActions = document.querySelector('.game-actions');
            if (gameActions) {
                gameActions.innerHTML = `
                    <span style="color: #28a745; font-weight: 600; margin-right: 10px;">üëÅÔ∏è ƒêang xem tr·∫≠n ƒë·∫•u</span>
                    <button class="btn btn-secondary" id="btn-leave-spectate">üö™ R·ªùi Xem</button>
                `;
                document.getElementById('btn-leave-spectate')?.addEventListener('click', leaveSpectate);
            }
            
            // Update title
            const gameTitle = document.querySelector('.game-title');
            if (gameTitle) {
                gameTitle.textContent = 'üëÅÔ∏è Xem Tr·∫≠n ƒê·∫•u - C·ªù T∆∞·ªõng Online';
            }
        }
        // --- QUAN TR·ªåNG: N·∫°p ngay th√¥ng tin tr·∫≠n ƒë·∫•u ƒë·ªÉ c√°c n√∫t b·∫•m ho·∫°t ƒë·ªông ---
        else if (matchData) {
            gameController.matchId = matchData.match_id;
            gameController.myColor = matchData.your_color;
            gameController.isOnlineMode = true;
            gameController.isMyTurn = (matchData.your_color === 'red'); 
            // L∆∞u √Ω: isMyTurn s·∫Ω ƒë∆∞·ª£c server c·∫≠p nh·∫≠t l·∫°i ch√≠nh x√°c sau khi connect
        }

        // Bi·∫øn to√†n c·ª•c cho Timer
        let timerInterval = null;
        let playerTime = 600; 
        let opponentTime = 600;
        let isGameActive = true;

        // Leave spectate function
        async function leaveSpectate() {
            try {
                if (gameController.network && spectateData) {
                    await gameController.network.leaveSpectate(spectateData.match_id);
                }
            } catch (e) {
                console.warn('Error leaving spectate:', e);
            }
            localStorage.removeItem('spectate_match');
            window.location.href = 'lobby.html';
        }

        // 3. K·∫øt n·ªëi Server & ƒê·ªìng b·ªô
        (async () => {
            try {
                const serverInfoStr = localStorage.getItem('xiangqi_server');
                if (!serverInfoStr) {
                    alert("M·∫•t th√¥ng tin server, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                    exitToLobby();
                    return;
                }

                const serverInfo = JSON.parse(serverInfoStr);
                const connected = await gameController.connectToServer(serverInfo.host, serverInfo.port);
                
                if (!connected) {
                    throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi Server Game");
                }

                // Restore token
                if (userData.token) {
                    gameController.token = userData.token;
                    if (gameController.network) gameController.network.sessionToken = userData.token;
                }

                // --- Spectate Mode: Load match state ---
                if (isSpectateMode && spectateData) {
                    // Join as spectator - match state is already in spectateData
                    const matchState = spectateData.match;
                    
                    if (matchState) {
                        // Replay all moves to current board state
                        gameController.setupBoard({ flipped: false });
                        
                        // Apply moves from match history
                        if (matchState.moves && matchState.moves.length > 0) {
                            for (const move of matchState.moves) {
                                gameController.board.movePiece(
                                    move.from.row, move.from.col,
                                    move.to.row, move.to.col
                                );
                            }
                            gameController.ui.render();
                        }
                        
                        // Update player panels for spectate
                        document.querySelector('#player-name')?.textContent && 
                            (document.querySelector('#player-name').textContent = `üî¥ Player #${matchState.red_user_id}`);
                        document.querySelector('#opponent-name')?.textContent && 
                            (document.querySelector('#opponent-name').textContent = `‚ö´ Player #${matchState.black_user_id}`);
                    }
                    
                    console.log('[Spectate] Watching match:', spectateData.match_id);
                }
                // Join Match ƒë·ªÉ ƒë·ªìng b·ªô tr·∫°ng th√°i m·ªõi nh·∫•t t·ª´ Server
                else if (matchData) {
                    const joinResult = await gameController.joinMatch(matchData.match_id);
                    
                    // C·∫≠p nh·∫≠t l·∫°i l∆∞·ª£t ƒëi t·ª´ server (tr√°nh b·ªã l·ªách l∆∞·ª£t khi refresh)
                    if (joinResult && joinResult.payload) {
                        const state = typeof joinResult.payload === 'string' ? JSON.parse(joinResult.payload) : joinResult.payload;
                        if (state.is_my_turn !== undefined) {
                            gameController.isMyTurn = state.is_my_turn;
                            updateTurnIndicator();
                        }
                    }
                    
                    // Setup b√†n c·ªù (Xoay n·∫øu l√† qu√¢n ƒêen)
                    const shouldFlip = matchData.your_color === 'black';
                    gameController.setupBoard({ flipped: shouldFlip });
                    if (gameController.ui && gameController.ui.flipBoard) {
                        gameController.ui.flipBoard(shouldFlip);
                    }
                }

                // --- L·∫ÆNG NGHE S·ª∞ KI·ªÜN T·ª™ SERVER ---
                if (gameController.network) {
                    // 1. ƒê·ªëi th·ªß ƒëi qu√¢n - sync timer
                    gameController.network.on('opponent_move', (data) => {
                        let payload = data.payload || data;
                        if (typeof payload === 'string') { try { payload = JSON.parse(payload); } catch(e) {} }
                        
                        // Sync timer from server
                        if (payload.red_time_ms !== undefined && payload.black_time_ms !== undefined) {
                            syncTimerFromServer(payload.red_time_ms, payload.black_time_ms);
                        }
                        
                        updateTurnIndicator();
                    });

                    // 2. Chat
                    gameController.network.on('chat_message', (data) => {
                        let payload = data.payload || data;
                        if (typeof payload === 'string') { try { payload = JSON.parse(payload); } catch(e) {} }

                        if (payload.username === userData.username) {
                            return; // B·ªè qua tin nh·∫Øn c·ªßa ch√≠nh m√¨nh
                        }

                        let senderDisplay = payload.username;
                        if (!senderDisplay || senderDisplay === 'Unknown') {
                            senderDisplay = matchData.opponent_name || 'ƒê·ªëi th·ªß';
                        }

                        addChatMessage(senderDisplay, payload.message, false);
                    });

                    // 3. Xin H√≤a (Draw Offer)
                    gameController.network.on('draw_offer', () => {
                        document.getElementById('draw-modal').classList.add('active');
                    });

                    // 4. TR·∫¨N ƒê·∫§U K·∫æT TH√öC (Quan tr·ªçng)
                    gameController.network.on('game_end', (data) => {
                        console.log("Game Over Event:", data);
                        
                        let payload = data.payload || data;
                        if (typeof payload === 'string') { try { payload = JSON.parse(payload); } catch(e) {} }

                        if (payload.red_rating && payload.black_rating) {
                            let newRating = (matchData.your_color === 'red') ? payload.red_rating : payload.black_rating;
                            let oppRating = (matchData.your_color === 'red') ? payload.black_rating : payload.red_rating;

                            if (newRating > 0) {
                                userData.rating = newRating;
                                
                                localStorage.setItem('xiangqi_user', JSON.stringify(userData));
                                
                                // 3. C·∫≠p nh·∫≠t UI Header ngay l·∫≠p t·ª©c
                                const ratingDisplay = document.getElementById('player-rating');
                                if (ratingDisplay) ratingDisplay.textContent = `‚≠ê ${newRating}`;
                                
                                // C·∫≠p nh·∫≠t c·∫£ rating ƒë·ªëi th·ªß tr√™n UI
                                const oppRatingDisplay = document.getElementById('opponent-rating');
                                if (oppRatingDisplay) oppRatingDisplay.textContent = `‚≠ê ${oppRating}`;
                                
                                // C·∫≠p nh·∫≠t s·ªë li·ªáu trong Modal K·∫øt qu·∫£
                                const resultNewRating = document.getElementById('result-new-rating');
                                if (resultNewRating) resultNewRating.textContent = newRating;
                            }
                        }
                        // -------------------------

                        let result = 'draw';
                        let reason = payload.reason || 'K·∫øt th√∫c';

                        if (payload.result === 'red_wins') {
                            result = (matchData.your_color === 'red') ? 'win' : 'loss';
                        } else if (payload.result === 'black_wins') {
                            result = (matchData.your_color === 'black') ? 'win' : 'loss';
                        }

                        showResult(result, reason);
                    });
                }

            } catch (e) {
                console.error('Setup failed:', e);
                alert("L·ªói k·∫øt n·ªëi: " + e.message);
                exitToLobby();
            }
        })();

        // --- UI & LOGIC ---

        // Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi ch∆°i
        document.getElementById('player-name').textContent = userData.username;
        document.getElementById('player-rating').textContent = `‚≠ê ${userData.rating || 1500}`;
        if (matchData) {
            document.getElementById('opponent-name').textContent = matchData.opponent_name || 'ƒê·ªëi th·ªß';
            document.getElementById('opponent-rating').textContent = `‚≠ê ${matchData.opponent_rating || 1500}`;
        }

        // Timer Logic - values in milliseconds from server
        let redTimeMs = 600000;  // 10 minutes default
        let blackTimeMs = 600000;
        
        function syncTimerFromServer(redMs, blackMs) {
            redTimeMs = redMs;
            blackTimeMs = blackMs;
            
            // Update display based on my color
            if (matchData && matchData.your_color === 'red') {
                playerTime = Math.ceil(redMs / 1000);
                opponentTime = Math.ceil(blackMs / 1000);
            } else {
                playerTime = Math.ceil(blackMs / 1000);
                opponentTime = Math.ceil(redMs / 1000);
            }
            
            updateTimerDisplay('player-timer', playerTime);
            updateTimerDisplay('opponent-timer', opponentTime);
        }
        
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (!isGameActive) {
                    clearInterval(timerInterval);
                    return;
                }

                if (gameController.isMyTurn) {
                    playerTime--;
                    updateTimerDisplay('player-timer', playerTime);
                    
                    // Check local timeout warning
                    if (playerTime <= 30 && playerTime > 0) {
                        document.getElementById('player-timer').classList.add('warning');
                    }
                    if (playerTime <= 0) {
                        handleTimeout('player');
                    }
                } else {
                    opponentTime--;
                    updateTimerDisplay('opponent-timer', opponentTime);
                }

                if (playerTime <= 0 || opponentTime <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }
        
        async function handleTimeout(who) {
            // Server should detect this but we can trigger resign
            if (who === 'player') {
                console.log('[Timer] Player timeout - server will end match');
                // Server s·∫Ω t·ª± detect v√† broadcast game_end
            }
        }
        
        // Sync timer t·ª´ server m·ªói 30 gi√¢y ƒë·ªÉ tr√°nh drift
        async function syncTimerPeriodically() {
            if (!isGameActive || !gameController.network || isSpectateMode) return;
            
            try {
                const response = await gameController.network.getTimer(gameController.matchId);
                if (response.success && response.payload?.timer) {
                    const timer = response.payload.timer;
                    syncTimerFromServer(timer.red_time_ms, timer.black_time_ms);
                }
            } catch (e) {
                console.warn('[Timer] Sync failed:', e);
            }
        }
        
        // Start periodic sync
        setInterval(syncTimerPeriodically, 30000);

        function updateTimerDisplay(id, seconds) {
            const el = document.getElementById(id);
            if(seconds < 0) seconds = 0;
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            el.textContent = `${m}:${s}`;
            el.classList.toggle('warning', seconds < 30);
        }

        function updateTurnIndicator() {
            const turnText = document.getElementById('turn-text');
            const playerPanel = document.getElementById('player-panel');
            const opponentPanel = document.getElementById('opponent-panel');

            if (gameController.isMyTurn) {
                turnText.innerHTML = '<span style="color:#27ae60">‚úÖ ƒê·∫øn l∆∞·ª£t b·∫°n</span>';
                playerPanel.classList.add('active');
                opponentPanel.classList.remove('active');
            } else {
                turnText.innerHTML = '<span style="color:#f39c12">‚è≥ ƒê·ªëi th·ªß ƒëang nghƒ©...</span>';
                playerPanel.classList.remove('active');
                opponentPanel.classList.add('active');
            }
        }

        // --- X·ª¨ L√ù K·∫æT TH√öC GAME ---

        function showResult(result, reason) {
            // 1. D·ª´ng game ngay l·∫≠p t·ª©c
            isGameActive = false;
            if (timerInterval) clearInterval(timerInterval);
            gameController.isOnlineMode = false; // Ch·∫∑n n∆∞·ªõc ƒëi m·ªõi

            // 2. Hi·ªán Modal K·∫øt Qu·∫£
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('result-title');
            const outcome = document.getElementById('result-outcome');
            const reasonText = document.getElementById('result-moves'); // T·∫°m d√πng field n√†y hi·ªán l√Ω do

            if (result === 'win') {
                title.textContent = 'üèÜ CHI·∫æN TH·∫ÆNG!';
                title.style.color = '#ffd700';
                outcome.textContent = 'B·∫°n ƒë√£ th·∫Øng';
            } else if (result === 'loss') {
                title.textContent = 'üíî TH·∫§T B·∫†I';
                title.style.color = '#ff4444';
                outcome.textContent = 'B·∫°n ƒë√£ thua';
            } else {
                title.textContent = 'ü§ù H√íA';
                title.style.color = '#4a90e2';
                outcome.textContent = 'Hai b√™n h√≤a nhau';
            }
            
            // Format reason for display
            let reasonDisplay = reason;
            if (reason === 'timeout') {
                reasonDisplay = result === 'loss' ? '‚è±Ô∏è H·∫øt gi·ªù (b·∫°n)' : '‚è±Ô∏è ƒê·ªëi th·ªß h·∫øt gi·ªù';
            } else if (reason === 'resign') {
                reasonDisplay = result === 'loss' ? 'üè≥Ô∏è B·∫°n ƒë·∫ßu h√†ng' : 'üè≥Ô∏è ƒê·ªëi th·ªß ƒë·∫ßu h√†ng';
            } else if (reason === 'checkmate') {
                reasonDisplay = '‚ôö Chi·∫øu h·∫øt';
            } else if (reason === 'agreement') {
                reasonDisplay = 'ü§ù ƒê·ªìng √Ω h√≤a';
            }
            
            reasonText.textContent = `L√Ω do: ${reasonDisplay}`;
            modal.classList.add('active');

            // 3. ƒê·∫øm ng∆∞·ª£c t·ª± ƒë·ªông tho√°t
            let countdown = 5;
            const btnLobby = document.getElementById('btn-to-lobby');
            const originalText = btnLobby.textContent;
            
            const autoExitInterval = setInterval(() => {
                countdown--;
                btnLobby.textContent = `V·ªÅ Lobby (${countdown}s)`;
                if (countdown <= 0) {
                    clearInterval(autoExitInterval);
                    exitToLobby();
                }
            }, 1000);
        }

        function exitToLobby() {
            localStorage.removeItem('current_match'); // X√≥a match c≈©
            if (window.gameController) window.gameController.disconnect();
            window.location.href = 'lobby.html';
        }

        // --- BUTTON EVENTS ---

        // N√∫t R·ªùi Tr·∫≠n (ƒê·∫ßu h√†ng tr∆∞·ªõc khi tho√°t)
        document.getElementById('btn-leave').addEventListener('click', async () => {
            if (!isGameActive) { exitToLobby(); return; }
            
            if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë·∫ßu h√†ng v√† r·ªùi tr·∫≠n?')) {
                try {
                    await gameController.resign(); // G·ª≠i l·ªánh thua
                } catch(e) { 
                    console.error(e); 
                } finally {
                    // ƒê·ª£i 500ms cho message ƒëi r·ªìi tho√°t
                    setTimeout(exitToLobby, 500);
                }
            }
        });

        // N√∫t Xin H√≤a
        document.getElementById('btn-draw-offer').addEventListener('click', async () => {
            if (!isGameActive) return;
            try {
                await gameController.offerDraw();
                alert('ƒê√£ g·ª≠i l·ªùi m·ªùi h√≤a!');
            } catch (error) {
                console.error(error);
                alert('L·ªói: ' + error.message);
            }
        });

        // N√∫t ƒê·∫ßu H√†ng
        document.getElementById('btn-resign').addEventListener('click', async () => {
            if (!isGameActive) return;
            if (confirm('B·∫°n mu·ªën ƒë·∫ßu h√†ng?')) {
                await gameController.resign();
            }
        });

        // X·ª≠ l√Ω Modal Xin H√≤a (ƒê·ªìng √Ω/T·ª´ ch·ªëi)
        document.getElementById('btn-accept-draw').addEventListener('click', async () => {
            document.getElementById('draw-modal').classList.remove('active');
            await gameController.network.respondDraw(gameController.matchId, true);
        });

        document.getElementById('btn-decline-draw').addEventListener('click', async () => {
            document.getElementById('draw-modal').classList.remove('active');
            await gameController.network.respondDraw(gameController.matchId, false);
        });

        // C√°c n√∫t trong Modal K·∫øt Qu·∫£
        document.getElementById('btn-new-game').addEventListener('click', exitToLobby);
        document.getElementById('btn-to-lobby').addEventListener('click', exitToLobby);

        // Rematch button in result modal
        let pendingRematchMatchId = null;
        
        document.getElementById('btn-rematch').addEventListener('click', async () => {
            const matchId = gameController.matchId;
            if (!matchId) {
                alert('Kh√¥ng th·ªÉ y√™u c·∫ßu ƒë·∫•u l·∫°i');
                return;
            }
            
            try {
                // Show waiting modal
                document.getElementById('result-modal').classList.remove('active');
                document.getElementById('rematch-waiting-modal').classList.add('active');
                
                await gameController.network.requestRematch(matchId);
                pendingRematchMatchId = matchId;
            } catch (e) {
                document.getElementById('rematch-waiting-modal').classList.remove('active');
                alert('L·ªói: ' + e.message);
            }
        });

        // Cancel rematch request
        document.getElementById('btn-cancel-rematch').addEventListener('click', () => {
            document.getElementById('rematch-waiting-modal').classList.remove('active');
            document.getElementById('result-modal').classList.add('active');
            pendingRematchMatchId = null;
        });

        // Accept rematch
        document.getElementById('btn-accept-rematch').addEventListener('click', async () => {
            const matchId = pendingRematchMatchId || gameController.matchId;
            document.getElementById('rematch-modal').classList.remove('active');
            
            try {
                gameController.network.respondRematch(matchId, true);
                // match_found event will handle the rest
            } catch (e) {
                console.error('Accept rematch error:', e);
            }
        });

        // Decline rematch
        document.getElementById('btn-decline-rematch').addEventListener('click', async () => {
            const matchId = pendingRematchMatchId || gameController.matchId;
            document.getElementById('rematch-modal').classList.remove('active');
            
            try {
                gameController.network.respondRematch(matchId, false);
            } catch (e) {
                console.error('Decline rematch error:', e);
            }
            pendingRematchMatchId = null;
        });

        // Listen for rematch request from opponent
        gameController.network.on('rematch_request', (msg) => {
            const data = msg.payload || msg;
            pendingRematchMatchId = data.match_id;
            const fromUsername = data.from_username || 'ƒê·ªëi th·ªß';
            
            document.getElementById('rematch-request-text').textContent = 
                `${fromUsername} mu·ªën ƒë·∫•u l·∫°i. B·∫°n ƒë·ªìng √Ω kh√¥ng?`;
            
            // Hide other modals, show rematch modal
            document.getElementById('result-modal').classList.remove('active');
            document.getElementById('rematch-waiting-modal').classList.remove('active');
            document.getElementById('rematch-modal').classList.add('active');
        });

        // Listen for rematch declined
        gameController.network.on('rematch_declined', (msg) => {
            document.getElementById('rematch-waiting-modal').classList.remove('active');
            document.getElementById('result-modal').classList.add('active');
            alert('ƒê·ªëi th·ªß ƒë√£ t·ª´ ch·ªëi ƒë·∫•u l·∫°i');
            pendingRematchMatchId = null;
        });

        // Listen for match_found (includes rematch)
        gameController.network.on('match_found', (msg) => {
            const data = msg.payload || msg;
            
            // Close all modals
            document.getElementById('rematch-modal').classList.remove('active');
            document.getElementById('rematch-waiting-modal').classList.remove('active');
            document.getElementById('result-modal').classList.remove('active');
            
            // Store new match data and reload
            localStorage.setItem('current_match', JSON.stringify(data));
            
            // Reload page for new game
            window.location.reload();
        });

        // Chat
        document.getElementById('btn-send-chat').addEventListener('click', sendChat);
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            try {
                // 1. G·ª≠i l√™n server
                await gameController.sendChatMessage(msg);
                
                // 2. Hi·ªÉn th·ªã ngay l·∫≠p t·ª©c (Optimistic UI)
                addChatMessage(userData.username, msg, true); // True = l√† tin m√¨nh g·ª≠i
                
                input.value = '';
            } catch (e) {
                console.error("L·ªói g·ª≠i tin nh·∫Øn:", e);
            }
        }

        function addChatMessage(senderName, msg, isMe) {
            const container = document.getElementById('chat-messages');
            
            // X√≥a th√¥ng b√°o tr·ªëng n·∫øu c√≥
            if (container.children.length > 0 && container.children[0].innerText === 'Tr√≤ chuy·ªán v·ªõi ƒë·ªëi th·ªß') {
                container.innerHTML = '';
            }

            const msgWrapper = document.createElement('div');
            msgWrapper.className = `chat-message ${isMe ? 'me' : 'opponent'}`;

            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = senderName;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = msg;

            msgWrapper.appendChild(senderDiv);
            msgWrapper.appendChild(bubbleDiv);
            container.appendChild(msgWrapper);

            // Cu·ªôn xu·ªëng cu·ªëi
            container.scrollTop = container.scrollHeight;
        }

        // Move History Update
        gameController.on('move-made', (move) => {
             const list = document.getElementById('moves-list');
             if (!list) return;
             
             // X√≥a d√≤ng th√¥ng b√°o "Ch∆∞a c√≥ n∆∞·ªõc ƒëi" n·∫øu c√≤n
             if (list.children.length > 0 && list.children[0].innerText.includes('Ch∆∞a c√≥')) {
                 list.innerHTML = '';
             }

             const item = document.createElement('div');
             item.className = 'move-record'; // Class n√†y ƒë√£ c√≥ CSS ·ªü b∆∞·ªõc tr∆∞·ªõc
             // Th√™m inline style ƒë·ªÉ ch·∫Øc ch·∫Øn hi·ªÉn th·ªã ƒë·∫πp ngay l·∫≠p t·ª©c
             item.style.display = 'flex';
             item.style.justifyContent = 'space-between';
             item.style.borderBottom = '1px solid #333';
             item.style.padding = '5px 0';
             
             // Format hi·ªÉn th·ªã: 1. ƒê·ªè: (R, C) -> (R, C)
             const turnNum = list.children.length + 1;
             
             // X√°c ƒë·ªãnh m√†u v√† t√™n
             const isRed = (move.color === 'red');
             const colorClass = isRed ? '#ff4444' : '#aaaaaa';
             const colorName = isRed ? "ƒê·ªè" : "ƒêen";

             const moveText = `${colorName}: (${move.from.row}, ${move.from.col}) ‚ûî (${move.to.row}, ${move.to.col})`;
             
             item.innerHTML = `
                <span style="color: #666; width: 30px;">${turnNum}.</span>
                <span style="color: ${colorClass}; font-weight: 500; text-align: right; flex: 1;">
                    ${moveText}
                </span>
             `;
             
             list.appendChild(item);
             list.scrollTop = list.scrollHeight;
        });

        // Kh·ªüi ch·∫°y
        startTimer();
        updateTurnIndicator();

    </script>
</body>
</html>
